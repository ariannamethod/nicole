#!/usr/bin/env python3
"""
Nicole Telegram - Telegram client for testing Nicole
Fluid neural network interface.
"""

import asyncio
import json
import time
import sys
import threading
import random
import os
from typing import Dict, Any, Optional
import sqlite3

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Nicole
import sys
import os
# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞—à–∏—Ö –º–æ–¥—É–ª–µ–π
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

import h2o
import high  # –ö–†–ò–¢–ò–ß–ù–û: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º high –î–û nicole!
import blood  # –ö–†–ò–¢–ò–ß–ù–û: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º blood –î–û nicole!
import nicole
import nicole2nicole  
import nicole_memory
import nicole_rag
import nicole_metrics

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
try:
    from load_env import load_env
    load_env()  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º .env –µ—Å–ª–∏ –µ—Å—Ç—å
except ImportError:
    pass

# Telegram Bot API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
try:
    from telegram import Update, Bot, BotCommand
    from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
    TELEGRAM_AVAILABLE = True
except ImportError:
    TELEGRAM_AVAILABLE = False
    print("[TelegramBot] python-telegram-bot not installed, using mock")

class MockTelegramBot:
    """Mock telegram bot for testing without API"""
    
    def __init__(self):
        self.chat_sessions = {}
        self.message_history = []
        self.is_running = False
        
    def start_polling(self):
        """Starts polling (simulation)"""
        self.is_running = True
        print("[TelegramBot] Bot started (simulation)")
        
    def stop_polling(self):
        """Stops polling"""
        self.is_running = False
        print("[TelegramBot] Bot stopped")
        
    def send_message(self, chat_id: str, text: str):
        """Sends message (simulation)"""
        message = {
            'chat_id': chat_id,
            'text': text,
            'timestamp': time.time(),
            'type': 'bot_message'
        }
        self.message_history.append(message)
        print(f"[Bot -> {chat_id}] {text}")
        
    def simulate_user_message(self, chat_id: str, text: str):
        """Simulates user message"""
        message = {
            'chat_id': chat_id,
            'text': text,
            'timestamp': time.time(),
            'type': 'user_message'
        }
        self.message_history.append(message)
        print(f"[{chat_id} -> Bot] {text}")
        return message

class RealTelegramBot:
    """Real Telegram bot for production"""
    
    def __init__(self, token: str):
        if not TELEGRAM_AVAILABLE:
            raise ImportError("python-telegram-bot not installed")
            
        self.token = token
        self.application = Application.builder().token(token).build()
        self.chat_sessions = {}
        self.message_history = []
        
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Command /start"""
        chat_id = str(update.effective_chat.id)
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º menu button –ø—Ä–∏ –ø–µ—Ä–≤–æ–º /start
        try:
            commands = [BotCommand("newconvo", "RESTART")]
            await self.application.bot.set_my_commands(commands)
        except Exception as e:
            print(f"[RealTelegramBot] Menu setup failed: {e}")
        
        welcome_msg = """üß† Hello! I'm NICOLE - Neural Intelligent Conversational Organism Language Engine.

I work without pre-trained weights, creating unique transformers for each dialogue.
I use Method Engine principles for proper speech and resonance.

Commands:
/newconvo - start new conversation"""
        
        await update.message.reply_text(welcome_msg)
        
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Command /help"""
        help_text = """ü§ñ NICOLE: Neural Intelligent Conversational Organism Language Engine

/newconvo - start new conversation

Just write me messages - I will learn and adapt!"""
        
        await update.message.reply_text(help_text)
        
    async def message_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Regular message handler"""
        try:
            chat_id = str(update.effective_chat.id)
            user_input = update.message.text
            
            # Log message
            self.message_history.append({
                'chat_id': chat_id,
                'text': user_input,
                'timestamp': time.time(),
                'type': 'user_message'
            })
            
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê–ï–ú —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏!
            if chat_id not in self.chat_sessions:
                # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
                chat_session_id = f"tg_{chat_id}"
                nicole.nicole_core.start_conversation(chat_session_id)
                self.chat_sessions[chat_id] = True  # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞
                print(f"[RealTelegramBot] –°–û–ó–î–ê–ù–ê –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è {chat_id} - High: {nicole.nicole_core.high_enabled}")
            else:
                # –°–µ—Å—Å–∏—è —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ - –ù–ï –¢–†–û–ì–ê–ï–ú –ï–ï!
                print(f"[RealTelegramBot] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é {nicole.nicole_core.session_id}")
            
            # –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
            print(f"[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] High enabled: {nicole.nicole_core.high_enabled}")
            print(f"[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] High is_active: {nicole.nicole_core.high_core.is_active if nicole.nicole_core.high_core else 'None'}")
            print(f"[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {len(user_input)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # Process through Nicole with ME principles
            response = nicole.nicole_core.process_message(user_input)
            
            # –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            print(f"[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"[–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê] –û—Ç–≤–µ—Ç: {response[:100]}...")
            
            # Log response
            self.message_history.append({
                'chat_id': chat_id,
                'text': response,
                'timestamp': time.time(),
                'type': 'bot_message'
            })
            
            await update.message.reply_text(response)
            
        except Exception as e:
            error_msg = f"Nicole Error: {str(e)}"
            print(f"[RealTelegramBot:ERROR] {error_msg}")
            await update.message.reply_text(error_msg)
    
    async def newconvo_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Command /newconvo - new conversation"""
        chat_id = str(update.effective_chat.id)
        
        # End current session but preserve memory
        if chat_id in self.chat_sessions:
            old_session = self.chat_sessions[chat_id]
            # Memory stays in SQLite, just create new session
            del self.chat_sessions[chat_id]
            
        await update.message.reply_text("‚ö° New conversation started. Memory preserved.")
    

    def setup_handlers(self):
        """Sets up command handlers"""
        self.application.add_handler(CommandHandler("start", self.start_command))
        self.application.add_handler(CommandHandler("help", self.help_command))
        self.application.add_handler(CommandHandler("newconvo", self.newconvo_command))
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.message_handler))
        
    def run_bot(self):
        """Runs the bot"""
        self.setup_handlers()
        print(f"[RealTelegramBot] Starting bot with token: {self.token[:10]}...")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º polling - menu button –Ω–∞—Å—Ç—Ä–æ–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        self.application.run_polling()

class NicoleTelegramInterface:
    """Nicole interface for Telegram"""
    
    def __init__(self):
        self.bot = MockTelegramBot()
        self.nicole_sessions = {}
        self.enhanced_nicole = self._setup_enhanced_nicole()
        self.command_handlers = {
            '/start': self._cmd_start,
            '/help': self._cmd_help,
            '/newconvo': self._cmd_reset
        }
        
    def _setup_enhanced_nicole(self):
        """–ò–°–ü–†–ê–í–õ–ï–ù–û: Telegram –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É Nicole"""
        class TelegramNicole:
            def __init__(self):
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä, –Ω–µ —Å–æ–∑–¥–∞–µ–º —Å–≤–æ–∏ –º–æ–¥—É–ª–∏
                self.core = nicole.nicole_core
                
            def process_message(self, user_input: str, chat_id: str) -> str:
                """–ü—Ä–æ—Å—Ç–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É Nicole"""
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
                expected_session = f"tg_{chat_id}"
                if not self.core.session_id or self.core.session_id != expected_session:
                    print(f"[TelegramInterface] –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é {expected_session}")
                    self.core.start_conversation(expected_session)
                else:
                    print(f"[TelegramInterface] –°–µ—Å—Å–∏—è {self.core.session_id} –∞–∫—Ç–∏–≤–Ω–∞")
                    
                # –ü–µ—Ä–µ–¥–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É - –æ–Ω–∞ —Å–∞–º–∞ –≤—Å–µ —Å–¥–µ–ª–∞–µ—Ç
                return self.core.process_message(user_input)
                
            def get_system_status(self) -> Dict:
                """Status of core Nicole system"""
                return {
                    'h2o_active_transformers': len(self.core.h2o_engine.executor.active_transformers),
                    'current_session': self.core.session_id,
                    'conversation_count': self.core.conversation_count,
                    'high_enabled': self.core.high_enabled,
                    'current_transformer': self.core.current_transformer.transformer_id if self.core.current_transformer else None
                }
                
        return TelegramNicole()
        
    def start_bot(self):
        """Starts telegram bot"""
        self.bot.start_polling()
        print("[NicoleTelegram] Interface ready!")
        
    def handle_message(self, chat_id: str, text: str) -> str:
        """Handles incoming message"""
        try:
            # Check commands
            if text.startswith('/'):
                command = text.split()[0]
                if command in self.command_handlers:
                    return self.command_handlers[command](chat_id, text)
                else:
                    return f"Unknown command: {command}"
                    
            # Regular message - pass to Nicole
            response = self.enhanced_nicole.process_message(text, chat_id)
            return response
            
        except Exception as e:
            error_msg = f"Error: {e}"
            print(f"[NicoleTelegram:ERROR] {error_msg}")
            return "Sorry, an error occurred. Please try again."
            
    def _cmd_start(self, chat_id: str, text: str) -> str:
        """Command /start"""
        return """üß† Hello! I'm NICOLE - Neural Intelligent Conversational Organism Language Engine.

I work without pre-trained weights, creating unique transformers for each dialogue.
I use Method Engine principles for proper speech and resonance.

Commands:
/newconvo - start new conversation

Just write me messages - I will learn and adapt!"""

    def _cmd_help(self, chat_id: str, text: str) -> str:
        """Command /help"""
        return """ü§ñ NICOLE: Neural Intelligent Conversational Organism Language Engine

/newconvo - start new conversation

Just write me messages - I will learn and adapt!"""

    def _cmd_stats(self, chat_id: str, text: str) -> str:
        """–ö–æ–º–∞–Ω–¥–∞ /stats"""
        try:
            status = self.enhanced_nicole.get_system_status()
            
            stats_text = f"""üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Nicole:

ü§ñ H2O Engine:
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤: {status['h2o_active_transformers']}
‚Ä¢ –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è: {status['current_session']}
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ—Å—Å–∏–∏: {status['conversation_count']}

üß† –û–±—É—á–µ–Ω–∏–µ:
‚Ä¢ –ò–∑—É—á–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {status['learning_stats'].get('learned_patterns', 0)}
‚Ä¢ –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: {status['learning_stats'].get('architecture_preferences', 0)}

üíæ –ü–∞–º—è—Ç—å:
‚Ä¢ –í—Å–µ–≥–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π: {status['memory_stats'].get('total_memories', 0)}
‚Ä¢ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π: {status['memory_stats'].get('total_associations', 0)}

üîç RAG:
‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤: {status['rag_stats'].get('total_queries', 0)}
‚Ä¢ –§–∞–∫—Ç–æ—Ä —Ö–∞–æ—Å–∞: {status['rag_stats'].get('chaos_factor', 0):.3f}

üéØ –¢–µ–∫—É—â–∏–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä: {status['current_transformer'] or '–ù–µ—Ç'}"""

            return stats_text
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}"
            
    def _cmd_reset(self, chat_id: str, text: str) -> str:
        """Command /newconvo"""
        try:
            if self.enhanced_nicole.core.session_id:
                self.enhanced_nicole.core.end_conversation()
                
            return "‚ö° New conversation started. Memory preserved."
            
        except Exception as e:
            return f"Error: {e}"

    def process_message(self, chat_id: str, message_text: str) -> str:
        """Processes user message"""
        # Log incoming message
        user_message = self.bot.simulate_user_message(chat_id, message_text)
        
        # Process message
        response = self.handle_message(chat_id, message_text)
        
        # Send response
        self.bot.send_message(chat_id, response)
        
        return response

def test_telegram_interface():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ–≥—Ä–∞–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
    print("=== NICOLE TELEGRAM INTERFACE TEST ===")
    
    # Create interface
    tg_interface = NicoleTelegramInterface()
    tg_interface.start_bot()
    
    # Simulate user
    test_chat_id = "test_user_123"
    
    # Test commands
    print("\\n--- Command Test ---")
    commands_to_test = [
        "/start",
        "/help",
        "/newconvo"
    ]
    
    for cmd in commands_to_test:
        print(f"\\n> {cmd}")
        response = tg_interface.process_message(test_chat_id, cmd)
        time.sleep(0.2)
        
    # Test regular conversation
    print("\\n--- Conversation Test ---")
    conversation = [
        "Hello Nicole! My name is Tester",
        "I study neural networks",
        "Tell me about yourself",
        "How do you work without weights?",
        "This is very interesting!",
        "Show me your evolution"
    ]
    
    for msg in conversation:
        print(f"\\n> {msg}")
        response = tg_interface.process_message(test_chat_id, msg)
        time.sleep(0.3)
        
    # Final statistics
    print("\\n--- Final Statistics ---")
    final_stats = tg_interface.process_message(test_chat_id, "/stats")
    
    print("\\n--- Evolution Test ---")
    evolution_result = tg_interface.process_message(test_chat_id, "/evolve")
    
    print("\\n--- Memory After Conversation ---")
    memory_result = tg_interface.process_message(test_chat_id, "/memory")
    
    print("\\n=== TELEGRAM TEST COMPLETED ===")

class InteractiveNicole:
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏"""
    
    def __init__(self):
        self.tg_interface = NicoleTelegramInterface()
        self.chat_id = "console_user"
        
    def start_interactive(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("ü§ñ Nicole Interactive Mode")
        print("–í–≤–µ–¥–∏—Ç–µ 'quit' –¥–ª—è –≤—ã—Ö–æ–¥–∞")
        print("-" * 40)
        
        self.tg_interface.start_bot()
        
        # Welcome
        welcome = self.tg_interface.process_message(self.chat_id, "/start")
        
        while True:
            try:
                user_input = input("\\nüë§ You: ").strip()
                
                if user_input.lower() in ['quit', 'exit']:
                    print("üëã Goodbye!")
                    break
                    
                if not user_input:
                    continue
                    
                # Process message
                response = self.tg_interface.process_message(self.chat_id, user_input)
                
            except KeyboardInterrupt:
                print("\\n\\nüëã Goodbye!")
                break
            except Exception as e:
                print(f"Error: {e}")

def run_production_bot():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–¥–∞–∫—à–µ–Ω –±–æ—Ç–∞ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º Telegram API"""
    token = os.getenv('TELEGRAM_TOKEN')
    if not token:
        print("‚ùå TELEGRAM_TOKEN not found in environment variables!")
        print("Create .env file or set environment variable")
        return
        
    if not TELEGRAM_AVAILABLE:
        print("‚ùå python-telegram-bot not installed!")
        print("Install: pip install python-telegram-bot")
        return
        
    print("üöÄ Starting Nicole Production Telegram Bot...")
    bot = RealTelegramBot(token)
    bot.run_bot()

if __name__ == "__main__":
    if len(sys.argv) > 1:
        if sys.argv[1] == "test":
            test_telegram_interface()
        elif sys.argv[1] == "interactive":
            interactive = InteractiveNicole()
            interactive.start_interactive()
        elif sys.argv[1] == "bot":
            run_production_bot()
    else:
        print("Nicole Telegram Interface")
        print("Commands:")
        print("  python3 nicole_telegram.py test - testing")
        print("  python3 nicole_telegram.py interactive - interactive mode") 
        print("  python3 nicole_telegram.py bot - production bot")
